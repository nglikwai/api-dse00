<% layout('layouts/boilerplate')%>

    <!-- <link rel="stylesheet" href="/stylesheets/stars.css"> -->

    <script>
        document.querySelector('title').innerText = '<%= campground.title %>';
    </script>

    <style>
        .good {
            color: rgb(239, 184, 47);
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="/stylesheets/show.css">


    <div class="index-loop">
        <div>
            <a href="/" class="btn dse00btn">Back</a>

            <div id="campgroundCarousel" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    <% campground.images.forEach((img, i)=> { %>
                        <div class="carousel-item <%= i === 0 ? 'active' : ''%>">
                            <img src="<%= img.url%>" class="d-block w-100" alt="">
                        </div>
                        ƒ
                        <% }) %>
                </div>
                <% if(campground.images.length> 1) {%>
                    <a class="carousel-control-prev" href="#campgroundCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">上</span>
                    </a>
                    <a class="carousel-control-next" href="#campgroundCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">下</span>
                    </a>
                    <% } %>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title m-3">
                        <%= campground.title%>
                    </h5>
                    <p class="card-text m-3 mb-5 mt-5">
                        <%= campground.description%>
                    </p>
                </div>
                <div>
                    <span class="muted">
                        <%= campground.createdAt.toLocaleString().substring(0,9) %>
                    </span>
                    <a class="category2" href="/search?category=<%= campground.category %>">
                        <%= campground.category %>
                    </a>
                </div>
                <ul class="list-group list-group-flush">

                    <li id="userbar">樓主 ：
                        <a href="/users/user/<%= campground.author._id %> ">
                            <b>
                                <%= campground.author.username.toUpperCase()%>
                            </b>
                            <span <%=campground.author.grade==='5**' ? 'class=good': 'class=grade' %>> - Lv <%=campground.author.grade %></span>
                        </a>
                    </li>

                </ul>
                <% if(currentUser) {%>
                    <% if (campground.author.equals(currentUser._id) || currentUser.identity=='admin' ) { %>
                        <div class="mt-3 mb-2">
                            <a class="btn dse00btn" href="/<%=campground._id%>/edit">修改</a>
                            <form class="d-inline" action="/<%=campground._id%>?_method=DELETE" method="POST">
                                <button class="btn dse00btn">刪除</button>
                            </form>
                        </div>
                        <% } %>
                            <% } %>
                                <!-- <div class="card-footer text-muted">
                            2 days ago
                        </div> -->
            </div>
            <% if (replyReview)  { %>
                <form action="/reply/<%= replyReview._id %>?post=<%=campground._id%>" method="POST" class="mb-3 validated-form" novalidate>
                    <div class="mb-5 mt-5">

                        <div class="quote"> ➼ Re :
                            <%= replyReview.author.username %> -
                                <%= replyReview.body %>
                        </div>
                        <textarea class="form-control muted" name="review[reply]" id="body" cols="20" rows="2" required style="width:80%" autofocus> </textarea>

                        <button class="btn dse00btn2 mt-0 mb-5">回覆</button>


                        <% } else{%>
                            <form action="/<%=campground._id%>/reviews" method="POST" class="mb-3 validated-form" novalidate>
                                <div class="mb-5 mt-5">
                                    <label class="form-label  mb-4" for="body">留言文字</label>
                                    <textarea class="form-control" name="review[body]" id="body" cols="30" rows="3" required></textarea>

                                    <div class="valid-feedback">
                                        Looks good!
                                    </div>

                                    <button class="btn dse00btn">提交</button>
                                    <% } %>
                                </div>
                            </form>
                            <% if (campground.reviews.length==0) { %>
                                <h4 style="margin-top:60px">未有留言</h4>
                                <% } else{%>
                                    <h4 style="margin-top:60px">留言</h4>
                                    <% for(let review of campground.reviews) { %>
                                        <div>
                                            <div id="delete">
                                                <% if(currentUser) {%>
                                                    <% if (review.author.equals(currentUser._id) || currentUser.identity=='admin' ) { %>
                                                        <div style="float: right">
                                                            <form action="/<%=campground._id%>/reviews/<%=review._id%>?_method=DELETE" method="POST">
                                                                <button onclick="return confirm('Delete?')" class="btn dse00btn" style="border:none">X</button>
                                                            </form>
                                                        </div>
                                                        <% } %>
                                                            <% } %>
                                            </div>
                                            <div class="mb-3">
                                                <div class="card-body">
                                                    <div class="mb-1">

                                                        <!-- <img src="https://devshift.biz/wp-content/uploads/2017/04/profile-icon-png-898.png"> -->
                                                        <a class="review-title" href="/users/user/<%= review.author._id %> ">
                                                            <%= review.author.username.toUpperCase()%>
                                                                <span <%=review.author.grade==='5**' ? 'class=good': 'class=grade' %> >- Lv <%= review.author.grade %></span>
                                                                <span class="muted">
                                                <%= review.createdAt.toLocaleString().substring(0,9) %>
                                            </span>
                                                        </a>
                                                    </div>
                                                    <div class="index-loop">
                                                        <p>
                                                            <%= review.body %>
                                                        </p>
                                                    </div>
                                                    <div class="pl-3 pb-4">
                                                        <% if (review.reply) { %>
                                                            <% for( let i = 0; i < review.reply.length; i++ ) { %>
                                                                <p class="quote p-0 m-0">
                                                                    ➼
                                                                    <%= review.replyAuthor[i] %> ：
                                                                        <%= review.reply[i] %>
                                                                </p>
                                                                <% } %>
                                                    </div>
                                                    <% } %>
                                                        <a href="/reply/<%= review._id %>?post=<%= campground._id %>" class="btn replybtn m-0">REPLY</a>




                                                </div>
                                            </div>

                                        </div>
                                        <% } %>

                                            <% } %>
                    </div>
                    <!-- <div class="col-4">hihihi</div> -->

                    <script>
                        const mapToken = '<%- process.env.MAPBOX_TOKEN%>';
                        const campground = <% - JSON.stringify(campground) %>;
                    </script>